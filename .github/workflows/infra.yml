# .github/workflows/infra.yml
name: Infra Reusable

on:
  workflow_call:
    inputs:
      PREFIX:    { required: true, type: string }   # ‚Üê single source of truth
      LOCATION:  { required: true, type: string }
      PLAN_SKU:  { required: true, type: string }
      TIMEOUT:   { required: true, type: number }
    secrets:
      AZURE_CREDENTIALS:     { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }
    outputs:
      rg:
        description: 'Resource-group name'
        value: ${{ jobs.provision.outputs.rg }}
      app:
        description: 'Web-App name'
        value: ${{ jobs.provision.outputs.app }}
      cosmos:
        description: 'Cosmos DB account name'
        value: ${{ jobs.provision.outputs.cosmos }}
      sched_func:
        description: 'Scheduler Function-App name'
        value: ${{ jobs.provision.outputs.sched_func }}
      static_site:
        description: 'Static Web App name'
        value: ${{ jobs.provision.outputs.static_site }}
      # ‚ü®NEW‚ü© images storage outputs
      images_account_name:
        description: 'Images Storage Account name'
        value: ${{ jobs.provision.outputs.images_account_name }}
      images_account_id:
        description: 'Images Storage Account resource ID'
        value: ${{ jobs.provision.outputs.images_account_id }}
      avatars_container_name:
        description: 'Avatars container name'
        value: ${{ jobs.provision.outputs.avatars_container_name }}
      images_blob_endpoint:
        description: 'Images blob endpoint (https://<acct>.blob.core.windows.net/)'
        value: ${{ jobs.provision.outputs.images_blob_endpoint }}

jobs:
  provision:
    runs-on: ubuntu-latest
    env:                               # computed once ‚Äì reused everywhere
      PREFIX: ${{ inputs.PREFIX }}
      RG:     ${{ inputs.PREFIX }}-rg
    outputs:
      rg:          ${{ env.RG }}
      app:         ${{ steps.infra.outputs.app }}
      cosmos:      ${{ steps.infra.outputs.cosmos }}
      sched_func:  ${{ steps.infra.outputs.sched_func }}
      static_site: ${{ steps.infra.outputs.static_site }}
      # ‚ü®NEW‚ü© images storage
      images_account_name:    ${{ steps.infra.outputs.images_account_name }}
      images_account_id:      ${{ steps.infra.outputs.images_account_id }}
      avatars_container_name: ${{ steps.infra.outputs.avatars_container_name }}
      images_blob_endpoint:   ${{ steps.infra.outputs.images_blob_endpoint }}

    steps:
      - uses: actions/checkout@v3

      - uses: azure/login@v1
        with:
          auth-type: SERVICE_PRINCIPAL
          creds:     ${{ secrets.AZURE_CREDENTIALS }}

      # ‚îÄ‚îÄ Ensure RP for Azure Maps is registered (idempotent) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Ensure Microsoft.Maps resource provider is registered
        shell: bash
        run: |
          set -eo pipefail
          az provider register --namespace Microsoft.Maps || true
          for i in {1..30}; do
            state=$(az provider show -n Microsoft.Maps --query registrationState -o tsv || true)
            if [[ "$state" == "Registered" ]]; then
              echo "‚úÖ Microsoft.Maps provider is Registered"
              break
            fi
            echo "‚è≥ Microsoft.Maps registrationState=$state ‚Äì waiting ‚Ä¶"
            sleep 5
          done

      # ‚îÄ‚îÄ Ensure the resource-group exists (idempotent) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Ensure resource group exists
        shell: bash
        run: |
          set -eo pipefail
          az group create \
            --name     "$RG" \
            --location "${{ inputs.LOCATION }}"

      # ‚îÄ‚îÄ Ensure or create AAD app registration ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Ensure AAD app registration
        id: aad
        shell: bash
        run: |
          set -eo pipefail
          TENANT_ID=$(az account show --query tenantId -o tsv)
          APP_NAME="${PREFIX}-aad"
          CLIENT_ID=$(az ad app list --display-name "$APP_NAME" --query "[0].appId" -o tsv)

          if [[ -z "$CLIENT_ID" ]]; then
            CLIENT_ID=$(az ad app create \
                          --display-name "$APP_NAME" \
                          --sign-in-audience AzureADMyOrg \
                          --query appId -o tsv)
            echo "Created AAD app registration $APP_NAME ($CLIENT_ID)"
          else
            echo "Re-using existing AAD app $APP_NAME ($CLIENT_ID)"
          fi

          echo "::add-mask::$CLIENT_ID"
          echo "tenant_id=$TENANT_ID" >> $GITHUB_OUTPUT
          echo "client_id=$CLIENT_ID" >> $GITHUB_OUTPUT

      # ‚îÄ‚îÄ Deploy all infra (Bicep) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: Deploy Bicep infra
        id: infra
        shell: bash
        run: |
          set -eo pipefail
          DEPLOY_NAME=gh-${{ github.run_id }}

          az deployment group create \
            --name          $DEPLOY_NAME \
            --resource-group "$RG" \
            --template-file infra/main.bicep \
            --parameters \
              prefix=${PREFIX} \
              planSkuName=${{ inputs.PLAN_SKU }} \
              timeout=${{ inputs.TIMEOUT }} \
              aadTenantId=${{ steps.aad.outputs.tenant_id }} \
              aadClientId=${{ steps.aad.outputs.client_id }}

          COSMOS=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                     --query "properties.outputs.cosmosAccountName.value" -o tsv)
          SCHED=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                     --query "properties.outputs.schedulerFunctionName.value" -o tsv)
          STATIC=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                     --query "properties.outputs.staticSiteName.value" -o tsv)
          APP=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                     --query "properties.outputs.webAppName.value" -o tsv)

          # ‚ü®NEW‚ü© images outputs
          IMG_ACCT=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                       --query "properties.outputs.imagesAccountName.value" -o tsv)
          IMG_ID=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                       --query "properties.outputs.imagesAccountId.value" -o tsv)
          AVATARS=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                       --query "properties.outputs.avatarsContainerName.value" -o tsv)
          IMG_BLOB=$(az deployment group show -g "$RG" -n $DEPLOY_NAME \
                       --query "properties.outputs.imagesBlobEndpoint.value" -o tsv)

          echo "cosmos=$COSMOS"      >> $GITHUB_OUTPUT
          echo "sched_func=$SCHED"   >> $GITHUB_OUTPUT
          echo "static_site=$STATIC" >> $GITHUB_OUTPUT
          echo "app=$APP"            >> $GITHUB_OUTPUT

          echo "images_account_name=$IMG_ACCT"       >> $GITHUB_OUTPUT
          echo "images_account_id=$IMG_ID"           >> $GITHUB_OUTPUT
          echo "avatars_container_name=$AVATARS"     >> $GITHUB_OUTPUT
          echo "images_blob_endpoint=$IMG_BLOB"      >> $GITHUB_OUTPUT

          echo "üèó infra ready ‚Äì rg=$RG, app=$APP, cosmos=$COSMOS, scheduler=$SCHED, static_site=$STATIC, images=$IMG_ACCT"
