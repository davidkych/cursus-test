# .github/workflows/static-web.yml
name: Frontend Static Web App

on:
  # invoked from deploy.yml
  workflow_call:
    inputs:
      RG:                 { required: true, type: string }
      STATIC_SITE_NAME:   { required: true, type: string }
    secrets:
      AZURE_CREDENTIALS:  { required: true }

permissions:
  contents: read
  id-token: write          # OIDC for azure/login

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      RG:               ${{ inputs.RG }}
      STATIC_SITE_NAME: ${{ inputs.STATIC_SITE_NAME }}

    steps:
      - uses: actions/checkout@v3

      # â”€â”€ Azure login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: azure/login@v1
        with:
          auth-type: SERVICE_PRINCIPAL
          creds:     ${{ secrets.AZURE_CREDENTIALS }}

      # â”€â”€ Build the Vue front-end â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package.json

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Build
        working-directory: frontend
        run: npm run build

      # â”€â”€ Fetch a short-lived deployment token directly from Azure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Obtain Static Web App deployment token
        id: swa_token
        uses: azure/CLI@v2
        with:
          inlineScript: |
            set -eo pipefail
            TOKEN=$(az staticwebapp secrets list \
                      --name "${STATIC_SITE_NAME}" \
                      --resource-group "${RG}" \
                      --query properties.apiKey -o tsv)
            echo "::add-mask::$TOKEN"
            echo "TOKEN=$TOKEN" >> $GITHUB_OUTPUT

      # â”€â”€ Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy to Azure Static Web Apps
        uses: Azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ steps.swa_token.outputs.TOKEN }}
          repo_token:                      ${{ secrets.GITHUB_TOKEN }}
          action: upload
          app_location:    frontend
          output_location: dist

      # â”€â”€ NEW: shout the real public URL so itâ€™s hard to miss â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“£  Show deployed site URL
        shell: bash
        run: |
          set -eo pipefail
          HOST=$(az staticwebapp show \
                   --name "${STATIC_SITE_NAME}" \
                   --resource-group "${RG}" \
                   --query properties.defaultHostname -o tsv)
          echo "ðŸš€ Static site is live â†’ https://${HOST}"
          echo "url=https://${HOST}" >> $GITHUB_OUTPUT
