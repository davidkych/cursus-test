name: Azure Deployment (Test)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  RG:          cursus-test-rg
  LOCATION:    eastasia
  APP:         cursus-test-app
  PLAN_SKU:    B1
  TIMEOUT:     1800

jobs:
  infra:
    uses: ./.github/workflows/infra.yml
    with:
      RG:       ${{ env.RG }}
      PLAN_SKU: ${{ env.PLAN_SKU }}
      TIMEOUT:  ${{ env.TIMEOUT }}
    secrets:
      AZURE_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  webapp:
    needs: infra
    uses: ./.github/workflows/webapp-deploy.yml
    with:
      RG:      ${{ env.RG }}
      APP:     ${{ env.APP }}
      TIMEOUT: ${{ env.TIMEOUT }}
      COSMOS:  ${{ needs.infra.outputs.cosmos }}
    secrets:
      AZURE_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  scheduler:
    needs: webapp
    uses: ./.github/workflows/scheduler-deploy.yml
    with:
      RG:         ${{ env.RG }}
      APP:        ${{ env.APP }}
      TIMEOUT:    ${{ env.TIMEOUT }}
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
    secrets:
      AZURE_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
