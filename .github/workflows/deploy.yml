﻿# .github/workflows/deploy.yml
name: Azure Deployment (Test)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

# These values are handy inside individual steps; they are **not** used in any
# job-level expressions, so the parser no longer complains.
env:
  RG:       cursus-test-rg
  LOCATION: eastasia
  APP:      cursus-test-app
  PLAN_SKU: B1
  TIMEOUT:  1800          # seconds

jobs:
  # ─────────────────────────── infra ───────────────────────────
  infra:
    uses: ./.github/workflows/infra.yml
    with:
      RG:       cursus-test-rg
      LOCATION: eastasia
      PLAN_SKU: B1
      TIMEOUT:  1800
    secrets:
      AZURE_CREDENTIALS:     ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ────────────────────────── web-app ──────────────────────────
  web_app:
    needs: infra
    uses: ./.github/workflows/web-app.yml
    with:
      RG:         cursus-test-rg
      APP:        cursus-test-app
      TIMEOUT:    1800
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  # ───────────────────────── scheduler ─────────────────────────
  scheduler:
    needs: infra
    uses: ./.github/workflows/scheduler.yml
    with:
      RG:         cursus-test-rg
      APP:        cursus-test-app
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  # ──────────────────────── static-web ─────────────────────────
  static_web:
    needs: infra
    uses: ./.github/workflows/static-web.yml
    with:
      RG:               cursus-test-rg
      STATIC_SITE_NAME: ${{ needs.infra.outputs.static_site }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}


Location: C:\Users\david\Documents\cursus-test\.github\workflows\infra.yml
------------------------------------------------------------
# .github/workflows/infra.yml
name: Infra Reusable

on:
  workflow_call:
    inputs:
      RG:        { required: true, type: string }
      LOCATION:  { required: true, type: string }
      PLAN_SKU:  { required: true, type: string }
      TIMEOUT:   { required: true, type: number }
    secrets:
      AZURE_CREDENTIALS:     { required: true }
      AZURE_SUBSCRIPTION_ID: { required: true }
    outputs:
      cosmos:
        description: 'Cosmos DB account name'
        value: ${{ jobs.provision.outputs.cosmos }}
      sched_func:
        description: 'Scheduler Function-App name'
        value: ${{ jobs.provision.outputs.sched_func }}
      static_site:                             # ← NEW
        description: 'Static Web App name'
        value: ${{ jobs.provision.outputs.static_site }}

jobs:
  provision:
    runs-on: ubuntu-latest
    outputs:
      cosmos:      ${{ steps.infra.outputs.cosmos }}
      sched_func:  ${{ steps.infra.outputs.sched_func }}
      static_site: ${{ steps.infra.outputs.static_site }}   # ← NEW

    steps:
      - uses: actions/checkout@v3

      - uses: azure/login@v1
        with:
          auth-type: SERVICE_PRINCIPAL
          creds:     ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy Bicep infra
        id: infra
        run: |
          set -eo pipefail
          DEPLOY_NAME=gh-${{ github.run_id }}

          az deployment group create \
            --name $DEPLOY_NAME \
            --resource-group ${{ inputs.RG }} \
            --template-file infra/main.bicep \
            --parameters planSkuName=${{ inputs.PLAN_SKU }} timeout=${{ inputs.TIMEOUT }}

          COSMOS=$(az deployment group show -g ${{ inputs.RG }} -n $DEPLOY_NAME \
                     --query "properties.outputs.cosmosAccountName.value" -o tsv)
          SCHED=$(az deployment group show -g ${{ inputs.RG }} -n $DEPLOY_NAME \
                     --query "properties.outputs.schedulerFunctionName.value" -o tsv)
          STATIC=$(az deployment group show -g ${{ inputs.RG }} -n $DEPLOY_NAME \
                     --query "properties.outputs.staticSiteName.value" -o tsv)

          echo "cosmos=$COSMOS"      >> $GITHUB_OUTPUT
          echo "sched_func=$SCHED"   >> $GITHUB_OUTPUT
          echo "static_site=$STATIC" >> $GITHUB_OUTPUT

          echo "🏗 infra ready – cosmos=$COSMOS, scheduler=$SCHED, static_site=$STATIC"