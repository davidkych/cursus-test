# .github/workflows/deploy.yml
name: Azure Deployment (Test)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents:  read

env:                     # only global, non-derived constants here
  LOCATION: eastasia
  PLAN_SKU: B1
  TIMEOUT:  1800         # seconds

jobs:
  # ─────────────────────────── infra ───────────────────────────
  infra:
    uses: ./.github/workflows/infra.yml
    with:
      PREFIX:   cursus-test1         # ← single source-of-truth for all names
      LOCATION: eastasia
      PLAN_SKU: B1
      TIMEOUT:  1800
    secrets:
      AZURE_CREDENTIALS:     ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ────────────────────────── web-app ──────────────────────────
  web_app:
    needs: infra
    uses: ./.github/workflows/web-app.yml
    with:
      RG:         ${{ needs.infra.outputs.rg }}
      APP:        ${{ needs.infra.outputs.app }}
      TIMEOUT:    1800
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      JWT_SECRET:        ${{ secrets.JWT_SECRET }}   # Maps key now injected by Bicep

  # ───────────────────────── scheduler ─────────────────────────
  scheduler:
    needs: infra
    uses: ./.github/workflows/scheduler.yml
    with:
      RG:         ${{ needs.infra.outputs.rg }}
      APP:        ${{ needs.infra.outputs.app }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  # ──────────────────────── static-web ─────────────────────────
  static_web:
    needs: infra
    uses: ./.github/workflows/static-web.yml
    with:
      RG:               ${{ needs.infra.outputs.rg }}
      STATIC_SITE_NAME: ${{ needs.infra.outputs.static_site }}
      APP:              ${{ needs.infra.outputs.app }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
