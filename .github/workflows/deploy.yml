# .github/workflows/deploy.yml
name: Azure Deployment (Targeted)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  id-token: write
  contents:  read

env:                     # only global, non-derived constants here
  LOCATION: eastasia
  PLAN_SKU: B1
  TIMEOUT:  1800         # seconds

jobs:
  # ──────────────────────── change-detection ────────────────────────
  changes:
    name: Detect changed territories
    runs-on: ubuntu-latest
    outputs:
      infra:       ${{ steps.filter.outputs.infra }}
      web_app:     ${{ steps.filter.outputs.web_app }}
      scheduler:   ${{ steps.filter.outputs.scheduler }}
      static_web:  ${{ steps.filter.outputs.static_web }}
      any_changed: ${{ steps.any.outputs.any_changed }}
    steps:
      - uses: actions/checkout@v4

      # Detect file changes per territory
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            infra:
              - 'infra/**'
              - '.github/workflows/infra.yml'
            web_app:
              - 'src/**'
              - '!src/scheduler_fapp/**'
              - '.github/workflows/web-app.yml'
            scheduler:
              - 'src/scheduler_fapp/**'
              - '.github/workflows/scheduler.yml'
            static_web:
              - 'frontend/**'
              - '.github/workflows/static-web.yml'

      # Single flag to know if anything relevant changed at all
      - id: any
        run: |
          if [[ "${{ steps.filter.outputs.infra }}" == "true" \
             || "${{ steps.filter.outputs.web_app }}" == "true" \
             || "${{ steps.filter.outputs.scheduler }}" == "true" \
             || "${{ steps.filter.outputs.static_web }}" == "true" ]]; then
            echo "any_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "any_changed=false" >> "$GITHUB_OUTPUT"
          fi

  # ─────────────────────────── infra ───────────────────────────
  # Runs first (gate) whenever any territory will deploy. It provides
  # the naming outputs used by the parallel jobs. Bicep is idempotent.
  infra:
    needs: changes
    if: needs.changes.outputs.any_changed == 'true'
    uses: ./.github/workflows/infra.yml
    with:
      PREFIX:   cursus-test1         # ← single source-of-truth for all names
      LOCATION: ${{ env.LOCATION }}
      PLAN_SKU: ${{ env.PLAN_SKU }}
      TIMEOUT:  ${{ env.TIMEOUT }}
    secrets:
      AZURE_CREDENTIALS:     ${{ secrets.AZURE_CREDENTIALS }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ────────────────────────── web-app ──────────────────────────
  web_app:
    needs: [infra, changes]
    if: needs.changes.outputs.web_app == 'true'
    uses: ./.github/workflows/web-app.yml
    with:
      RG:         ${{ needs.infra.outputs.rg }}
      APP:        ${{ needs.infra.outputs.app }}
      TIMEOUT:    ${{ env.TIMEOUT }}
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
      JWT_SECRET:        ${{ secrets.JWT_SECRET }}   # Maps key now injected by Bicep

  # ───────────────────────── scheduler ─────────────────────────
  scheduler:
    needs: [infra, changes]
    if: needs.changes.outputs.scheduler == 'true'
    uses: ./.github/workflows/scheduler.yml
    with:
      RG:         ${{ needs.infra.outputs.rg }}
      APP:        ${{ needs.infra.outputs.app }}
      SCHED_FUNC: ${{ needs.infra.outputs.sched_func }}
      COSMOS:     ${{ needs.infra.outputs.cosmos }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}

  # ──────────────────────── static-web ─────────────────────────
  static_web:
    needs: [infra, changes]
    if: needs.changes.outputs.static_web == 'true'
    uses: ./.github/workflows/static-web.yml
    with:
      RG:               ${{ needs.infra.outputs.rg }}
      STATIC_SITE_NAME: ${{ needs.infra.outputs.static_site }}
      APP:              ${{ needs.infra.outputs.app }}
    secrets:
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
